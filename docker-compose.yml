services:
  kafka:
    image: apache/kafka:3.7.0
    hostname: kafka
    container_name: kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    volumes:
      - kafka-data:/var/lib/kafka/data
      - ./server.properties:/opt/kafka/config/kraft/server.properties:ro
    entrypoint: ['/bin/sh', '-c']
    command: |
      "
      # Format storage if not already formatted
      if [ ! -f /var/lib/kafka/data/meta.properties ]; then
        echo 'Formatting Kafka storage for KRaft mode...'
        /opt/kafka/bin/kafka-storage.sh format --config /opt/kafka/config/kraft/server.properties --cluster-id MkU3OEVBNTcwNTJENDM2Qk --ignore-formatted
      fi
      
      # Start Kafka
      exec /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties
      "
    networks:
      - kafka-network
    healthcheck:
      test: ["CMD", "/opt/kafka/bin/kafka-broker-api-versions.sh", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 10

  kafka-init:
    image: apache/kafka:3.7.0
    hostname: kafka-init
    container_name: kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command: |
      "
      # Wait for Kafka to be ready
      echo 'Waiting for Kafka to be ready...'
      until /opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server kafka:29092 2>/dev/null; do
        echo 'Waiting for Kafka broker...'
        sleep 2
      done
      
      # Create sample topic
      echo 'Creating sample topic: sample-topic'
      /opt/kafka/bin/kafka-topics.sh --create \
        --bootstrap-server kafka:29092 \
        --replication-factor 1 \
        --partitions 3 \
        --topic sample-topic \
        --if-not-exists
      
      # List topics to verify
      echo 'Listing all topics:'
      /opt/kafka/bin/kafka-topics.sh --list --bootstrap-server kafka:29092
      
      echo 'Kafka KRaft setup complete!'
      "
    networks:
      - kafka-network

volumes:
  kafka-data:
    driver: local

networks:
  kafka-network:
    driver: bridge

